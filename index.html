<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mail Sender</title>
<style>
  body { font-family: Arial, sans-serif; padding: 10px; background: #f4f6f9; }
  h2 { text-align: center; margin-bottom: 10px; color: #333; }
  form {
    background-image: linear-gradient(to right,#ff4d00,#7d20cb);
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    max-width: 500px;
    margin: auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px 20px;
  }
  label { font-weight: bold; display: block; margin-bottom: 3px; color: #faf7f7; }
  input, select, button { padding: 5px; width: 100%; border: 3px solid #ccc; border-radius: 10px; font-size: 12px; }
  input:focus, select:focus { outline: none; border-color: #007bff; box-shadow: 0 0 5px rgba(0,123,255,0.4); }
  .hidden { display: none !important; }
  #accountDetails {
    grid-column: span 2;
    background-image: linear-gradient(to right,#ff4d00,#7d20cb);
    padding: 15px;
    border-radius: 8px;
    border: 2px solid #ddd;
    display: none;
    grid-template-columns: 1fr 1fr;
    gap: 10px 20px;
  }
  .error { color: red; grid-column: span 2; }
  button { background: #007bff; color: white; font-weight: bold; border: none; cursor: pointer; grid-column: span 2; transition: 0.3s; }
  button:hover { background: #0056b3; }
</style>
</head>
<body>

<h2>Branch Mail Sender</h2>
<form id="mailForm">
  <div>
    <label for="mailType">Mail Type*</label>
    <select id="mailType" required>
      <option value="">Select Mail Type</option>
      <option value="Packet Hold From The Auction">Packet Hold From The Auction</option>
      <option value="Packet Availability Confirmation">Packet Availability Confirmation</option>
      <option value="Customer Query For Auction Surplus">Customer Query For Auction Surplus</option>
      <option value="Customer Query for Auction Details">Customer Query for Auction Details</option>
      <option value="Handover the DD To The Customer">Handover the DD To The Customer</option>
      <option value="Transfer of Surplus Amount To Customer">Transfer of Surplus Amount To Customer</option>
    </select>
  </div>

  <div>
    <label for="glId">GL ID*</label>
    <input type="text" id="glId" pattern="\d+" required placeholder="Enter GL ID (numbers only)">
  </div>

  <div>
    <label for="customerName">Customer Name*</label>
    <input type="text" id="customerName" pattern="[A-Za-z\s]+" required placeholder="Enter Customer Name">
  </div>

  <div>
    <label for="customerNumber">Customer Number*</label>
    <input type="text" id="customerNumber" pattern="\d+" required placeholder="Enter Customer Number">
  </div>

  <div>
    <label for="branchNameInput">Branch Name*</label>
    <input list="branchList" id="branchNameInput" required placeholder="Select or type branch">
    <datalist id="branchList">
      <option value="Test">
      <option value="Fed - Pune /Phursungi">
    </datalist>
  </div>

  <div>
    <label for="mappedEmail">Mapped Email*</label>
    <input type="email" id="mappedEmail" readonly required placeholder="Mapped Email">
  </div>

  <div>
    <label for="regards">Regards*</label>
    <select id="regards" required>
      <option value="">Select</option>
      <option value="Vijay">Vijay</option>
      <option value="Manasa">Manasa</option>
      <option value="Yatish">Yatish</option>
      <option value="Arif">Arif</option>
      <option value="Kartik">Kartik</option>
      <option value="Rajendra">Rajendra</option>
      <option value="Prashanth">Prashanth</option>
      <option value="Vidyadhar">Vidyadhar</option>
      <option value="Asha">Asha</option>
      <option value="Eram">Eram</option>
      <option value="Archana">Archana</option>
      <option value="Nageena">Nageena</option>
      <option value="Sana">Sana</option>
      <option value="Azmath">Azmath</option>
      <option value="Fouziya">Fouziya</option>
      <option value="Krishnaveni">Krishnaveni</option>
      <option value="Margaret">Margaret</option>
    </select>
  </div>

  <div id="passwordDiv">
    <label for="password">Password*</label>
    <input type="password" id="password" placeholder="Enter Password">
  </div>

  <div id="accountDetails">
    <label for="bankAccount">Bank A/C Number*</label>
    <input type="text" id="bankAccount">

    <label for="bankName">Bank Name*</label>
    <input type="text" id="bankName">

    <label for="ifsc">IFSC Code*</label>
    <input type="text" id="ifsc">

    <label for="passbook">Passbook / Cheque Leaf*</label>
    <input type="file" id="passbook">

    <label for="aadhar">Aadhar Card (optional)</label>
    <input type="file" id="aadhar">

    <label for="pan">Pan Card (optional)</label>
    <input type="file" id="pan">
  </div>

  <div class="error" id="errorMsg"></div>
  <button type="submit" id="sendMailBtn">Send Mail</button>
</form>

<script>
const branchEmails = {
  "Test":"vidyadhar.patil@rupeek.com",
  "Fed - Pune / Pimple Saudagar":"pnei@federalbank.co.in"
};

const directSendWithPassword = ["Vijay","Manasa","Yatish","Arif","Kartik","Rajendra","Prashanth","Vidyadhar"];
const regardsPasswords = {
  "Vijay":"F6gQ3","Manasa":"t9Bv4","Yatish":"m3Pq2","Arif":"Z5yL0","Kartik":"A7d9X",
  "Rajendra":"R2hK8","Prashanth":"c7Nw1","Vidyadhar":"3834"
};
const approvalEmails = {
  "Asha":"arif.pasha@rupeek.com",
  "Eram":"arif.pasha@rupeek.com",
  "Archana":"arif.pasha@rupeek.com",
  "Nageena":"yatish.r@rupeek.com",
  "Sana":"yatish.r@rupeek.com",
  "Azmath":"m.manasa@rupeek.com",
  "Fouziya":"vijay.r01@rupeek.com",
  "Krishnaveni":"vijay.r01@rupeek.com",
  "Margaret":"vijay.r01@rupeek.com"
};

const mailType = document.getElementById('mailType');
const branchNameInput = document.getElementById('branchNameInput');
const mappedEmail = document.getElementById('mappedEmail');
const regards = document.getElementById('regards');
const password = document.getElementById('password');
const passwordDiv = document.getElementById('passwordDiv');
const form = document.getElementById('mailForm');
const errorMsg = document.getElementById('errorMsg');
const sendBtn = document.getElementById('sendMailBtn');
const customerNameInput = document.getElementById('customerName');
const accountDetails = document.getElementById('accountDetails');

branchNameInput.addEventListener('input', () => {
  mappedEmail.value = branchEmails[branchNameInput.value] || '';
});

customerNameInput.addEventListener('input', () => {
  let words = customerNameInput.value.split(' ');
  words = words.map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase());
  customerNameInput.value = words.join(' ');
});

regards.addEventListener('change', () => {
  if(directSendWithPassword.includes(regards.value)){
    passwordDiv.style.display = 'block';
  } else {
    passwordDiv.style.display = 'none';
    password.value = '';
  }

  if(mailType.value === "Transfer of Surplus Amount To Customer" && directSendWithPassword.includes(regards.value)){
    accountDetails.style.display = 'grid';
  } else {
    accountDetails.style.display = 'none';
  }
});

function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function getEmailContent(data){
  let subject='', body=`Dear Branch Staff,<br><br>`;
  switch(data.mailType){
    case "Packet Hold From The Auction":
      subject=`Hold The Packet From The Auction ${data.glId}-${data.customerName}`;
      body+=`Kindly hold the packet from the auction, as the customer is willing to do the payment<br><br>`;
      break;
    case "Packet Availability Confirmation":
      subject=`Packet Availability Confirmation ${data.glId}-${data.customerName}`;
      body+=`Kindly confirm the packet availability status for below mentioned customer, and the customer is willing to do the payment<br><br>`;
      break;
    case "Customer Query for Auction Details":
      subject=`Customer Query for Auction Details ${data.glId}-${data.customerName}`;
      body+=`Customer has reached out to us requesting the gold auction details. Please furnish the details.<br><br>`;
      break;
    case "Customer Query For Auction Surplus":
      subject=`Customer Query For Auction Surplus ${data.glId}-${data.customerName}`;
      body+=`Customer ${data.customerName} has requested auction surplus details. Please provide.<br><br>`;
      break;
    case "Transfer of Surplus Amount To Customer":
      subject=`Transfer of Surplus Amount To Customer ${data.glId}-${data.customerName}`;
      body+=`Customer requested transfer of surplus amount. Please confirm.<br><br>`;
      break;
    case "Handover the DD To The Customer":
      subject=`Handover the DD To The Customer ${data.glId}-${data.customerName}`;
      body+=`Customer requested available DD. Kindly handover.<br><br>`;
      break;
  }

  body += `<table style="width:100%; max-width:600px; border-collapse:collapse;">
    <tr><td style="background:#f4f6f9;font-weight:bold;padding:8px;border:1px solid #ddd;width:35%;">GL ID</td><td style="padding:8px;border:1px solid #ddd;">${data.glId}</td></tr>
    <tr><td style="background:#f4f6f9;font-weight:bold;padding:8px;border:1px solid #ddd;">Customer Name</td><td style="padding:8px;border:1px solid #ddd;">${data.customerName}</td></tr>
    <tr><td style="background:#f4f6f9;font-weight:bold;padding:8px;border:1px solid #ddd;">Customer Number</td><td style="padding:8px;border:1px solid #ddd;">${data.customerNumber}</td></tr>
    <tr><td style="background:#f4f6f9;font-weight:bold;padding:8px;border:1px solid #ddd;">Branch Name</td><td style="padding:8px;border:1px solid #ddd;">${data.branchName}</td></tr>
  </table>`;

  if(data.mailType==="Transfer of Surplus Amount To Customer" && data.bankAccount){
    body+= `<br><b>Bank Details:</b><br>
      <table style="width:100%; max-width:600px; border-collapse:collapse;">
      <tr><td style="background:#f4f6f9;font-weight:bold;padding:8px;border:1px solid #ddd;width:35%;">Bank A/C Number</td><td style="padding:8px;border:1px solid #ddd;">${data.bankAccount}</td></tr>
      <tr><td style="background:#f4f6f9;font-weight:bold;padding:8px;border:1px solid #ddd;">Bank Name</td><td style="padding:8px;border:1px solid #ddd;">${data.bankName}</td></tr>
      <tr><td style="background:#f4f6f9;font-weight:bold;padding:8px;border:1px solid #ddd;">IFSC Code</td><td style="padding:8px;border:1px solid #ddd;">${data.ifsc}</td></tr>
      </table><br><i>Supporting documents attached.</i>`;
  }

  body+=`<br><br>Regards,<br>${data.regards}`;
  return {subject, body};
}

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  errorMsg.textContent='';

  const regardName = regards.value;
  let toEmail;

  if(directSendWithPassword.includes(regardName)){
    if(!password.value || password.value!==regardsPasswords[regardName]){
      errorMsg.textContent="Password required or incorrect for selected Regards";
      return;
    }
    toEmail = mappedEmail.value; // direct send
  } else {
    toEmail = approvalEmails[regardName]; // send first for approval
  }

  const data = {
    mailType: mailType.value,
    glId: document.getElementById('glId').value,
    customerName: customerNameInput.value,
    customerNumber: document.getElementById('customerNumber').value,
    branchName: branchNameInput.value,
    regards: regardName,
    toEmail
  };

  if(mailType.value==="Transfer of Surplus Amount To Customer" && directSendWithPassword.includes(regardName)){
    data.bankAccount = document.getElementById('bankAccount').value;
    data.bankName = document.getElementById('bankName').value;
    data.ifsc = document.getElementById('ifsc').value;

    const passbookFile=document.getElementById('passbook').files[0];
    if(passbookFile) data.passbook=await fileToBase64(passbookFile);

    const aadharFile=document.getElementById('aadhar').files[0];
    if(aadharFile) data.aadhar=await fileToBase64(aadharFile);

    const panFile=document.getElementById('pan').files[0];
    if(panFile) data.pan=await fileToBase64(panFile);
  }

  const emailContent=getEmailContent(data);
  data.subject = emailContent.subject;
  data.body = emailContent.body;

  sendBtn.disabled=true; sendBtn.textContent="Sending...";

  try{
    const response = await fetch("https://script.google.com/macros/s/YOUR_DEPLOYED_WEB_APP_URL/exec", {
      method:"POST",
      body:JSON.stringify(data)
    });
    const result = await response.json();
    if(result.status==="success"){

      // Auto-forward approved mails to mapped branch email
      if(!directSendWithPassword.includes(regardName)){
        const forwardData = {...data, toEmail: mappedEmail.value};
        await fetch("https://script.google.com/macros/s/AKfycbzSat9Z78EeVkknqieEX2fucvXbJysYzUF_yIdn5NlVj_9PEY7mrWzdOdtqa9H2N9i5/exec", {
          method:"POST",
          body:JSON.stringify(forwardData)
        });
      }

      alert("Mail sent successfully!");
      form.reset();
      mappedEmail.value='';
      passwordDiv.style.display='none';
      accountDetails.style.display='none';
    } else {
      errorMsg.textContent = result.message;
    }
  } catch(err){
    errorMsg.textContent=err.message;
  }

  sendBtn.disabled=false; sendBtn.textContent="Send Mail";
});
</script>
</body>
</html>
