<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Auction Mail Tool</title>

<style>
body { font-family: Arial; padding: 20px; }
.hidden { display: none; }
label { font-weight: bold; margin-top: 10px; display: block; }
input, select { width: 250px; padding: 6px; }
button { margin-top: 15px; padding: 10px 25px; }
#error { color: red; font-weight: bold; }
</style>

</head>
<body>

<h2>Auction Mail Tool</h2>

<div id="error"></div>

<form id="mailForm">

<label>Mail Type</label>
<select id="mailType" required>
  <option value="">Select</option>
  <option>Packet Hold From The Auction</option>
  <option>Packet Availability Confirmation</option>
  <option>Customer Query for Auction Details</option>
  <option>Customer Query For Auction Surplus</option>
  <option>Transfer of Surplus Amount To Customer</option>
  <option>Handover the DD To The Customer</option>
</select>

<label>GL ID</label>
<input id="glId" required>

<label>Customer Name</label>
<input id="customerName" required>

<label>Customer Number</label>
<input id="customerNumber" required>

<label>Branch Name</label>
<input id="branchName" required>

<label>Mapped Email</label>
<input id="mappedEmail" required>

<label>Regards</label>
<select id="regards" required>
  <option value="">Select</option>

  <!-- Direct Send With Password -->
  <option>Vijay</option>
  <option>Manasa</option>
  <option>Yatish</option>
  <option>Arif</option>
  <option>Kartik</option>
  <option>Rajendra</option>
  <option>Prashanth</option>
  <option>Vidyadhar</option>

  <!-- Approval groups -->
  <option>Asha</option>
  <option>Eram</option>
  <option>Archana</option>
  <option>Nageena</option>
  <option>Sana</option>
  <option>Azmath</option>
  <option>Fouziya</option>
  <option>Krishnaveni</option>
  <option>Margaret</option>
</select>

<div id="passwordSection" class="hidden">
  <label>Password</label>
  <input id="password" type="password">
</div>

<!-- Account details for surplus -->
<div id="accountDetails" class="hidden">
  <h3>Bank Details</h3>

  <label>Bank Account</label>
  <input id="bankAccount">

  <label>Bank Name</label>
  <input id="bankName">

  <label>IFSC</label>
  <input id="ifsc">

  <label>Passbook</label>
  <input type="file" id="passbook">

  <label>Aadhar</label>
  <input type="file" id="aadhar">

  <label>PAN</label>
  <input type="file" id="pan">
</div>

<button type="submit">Send Mail</button>

</form>

<script>

// Approval groups
const approvalMap = {
  "Asha":"arif.pasha@rupeek.com",
  "Eram":"arif.pasha@rupeek.com",
  "Archana":"arif.pasha@rupeek.com",

  "Nageena":"yatish.r@rupeek.com",
  "Sana":"yatish.r@rupeek.com",

  "Azmath":"m.manasa@rupeek.com",
  "Manasa":"m.manasa@rupeek.com",

  "Fouziya":"vijay.r01@rupeek.com",
  "Krishnaveni":"vijay.r01@rupeek.com",
  "Margaret":"vijay.r01@rupeek.com"
};

// Users needing password
const directUsers = ["Vijay","Manasa","Yatish","Arif","Kartik","Rajendra","Prashanth","Vidyadhar"];

// Passwords
const passwords = {
  "Vijay":"F6gQ3", "Manasa":"t9Bv4", "Yatish":"m3Pq2",
  "Arif":"Z5yL0", "Kartik":"A7d9X", "Rajendra":"R2hK8",
  "Prashanth":"c7Nw1","Vidyadhar":"3834"
};

const form = document.getElementById("mailForm");
const regards = document.getElementById("regards");
const passwordSection = document.getElementById("passwordSection");
const mailType = document.getElementById("mailType");
const accountDetails = document.getElementById("accountDetails");

// Show password section only for direct users
regards.addEventListener("change", () => {
  if (directUsers.includes(regards.value)) {
    passwordSection.classList.remove("hidden");
  } else {
    passwordSection.classList.add("hidden");
  }
});

// Show bank section if surplus
mailType.addEventListener("change", () => {
  if (mailType.value === "Transfer of Surplus Amount To Customer") {
    accountDetails.classList.remove("hidden");
  } else {
    accountDetails.classList.add("hidden");
  }
});

// Convert file to base64
function toBase64(file) {
  return new Promise((resolve) => {
    if (!file) return resolve("");
    let reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.readAsDataURL(file);
  });
}

// Build email body
function getEmailContent(d) {
  let subject = "";
  let body = `Dear Branch Staff,<br><br>`;

  switch (d.mailType) {
    case "Packet Hold From The Auction":
      subject = `Hold The Packet From The Auction ${d.glId}-${d.customerName}`;
      body += "Kindly hold the packet from the auction...<br><br>";
      break;

    case "Packet Availability Confirmation":
      subject = `Packet Availability Confirmation ${d.glId}-${d.customerName}`;
      body += "Kindly confirm packet availability...<br><br>";
      break;

    case "Customer Query for Auction Details":
      subject = `Customer Query for Auction Details ${d.glId}-${d.customerName}`;
      body += "Customer requested auction details...<br><br>";
      break;

    case "Customer Query For Auction Surplus":
      subject = `Customer Query For Auction Surplus ${d.glId}-${d.customerName}`;
      body += "Customer requested surplus details...<br><br>";
      break;

    case "Transfer of Surplus Amount To Customer":
      subject = `Transfer of Surplus Amount ${d.glId}-${d.customerName}`;
      body += "Customer requested surplus transfer...<br><br>";
      break;

    case "Handover the DD To The Customer":
      subject = `Handover the DD To The Customer ${d.glId}-${d.customerName}`;
      body += "Customer requested DD handover...<br><br>";
      break;
  }

  body += `
  <br>
  GL ID: ${d.glId}<br>
  Customer Name: ${d.customerName}<br>
  Customer Number: ${d.customerNumber}<br>
  Branch: ${d.branchName}<br>
  <br>Regards,<br>${d.regards}
  `;

  return { subject, body };
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  error.textContent = "";

  // Validate password
  if (directUsers.includes(regards.value)) {
    if (document.getElementById("password").value !== passwords[regards.value]) {
      error.textContent = "Invalid password";
      return;
    }
  }

  let passbook = await toBase64(document.getElementById("passbook").files[0]);
  let aadhar  = await toBase64(document.getElementById("aadhar").files[0]);
  let pan     = await toBase64(document.getElementById("pan").files[0]);

  const mapped = document.getElementById("mappedEmail").value;
  const approval = approvalMap[regards.value];

  const sendTo = directUsers.includes(regards.value)
    ? mapped
    : approval;

  const d = {
    mailType: mailType.value,
    glId: glId.value,
    customerName: customerName.value,
    customerNumber: customerNumber.value,
    branchName: branchName.value,
    mappedEmail: mapped,
    regards: regards.value,
    sendTo: sendTo,
    password: document.getElementById("password").value,

    bankAccount: bankAccount.value,
    bankName: bankName.value,
    ifsc: ifsc.value,
    passbook: passbook,
    passbookType: document.getElementById("passbook").files[0]?.type || "",
    aadhar: aadhar,
    aadharType: document.getElementById("aadhar").files[0]?.type || "",
    pan: pan,
    panType: document.getElementById("pan").files[0]?.type || ""
  };

  // Add subject + body
  const email = getEmailContent(d);
  d.subject = email.subject;
  d.body = email.body;

  // Send to Apps Script
  fetch("https://script.google.com/macros/s/AKfycbzCt93JFMw1HZMoREmP3GSZOun3h4T93B0kmJDtW7_bwQWEFOTeHz58GbXcSxHwZznl/exec", {
    method: "POST",
    body: JSON.stringify(d),
    headers: { "Content-Type": "application/json" }
  })
  .then(r => r.json())
  .then(res => {
    if (res.status === "success") {
      alert("Mail Sent!");
      form.reset();
    } else {
      error.textContent = res.message;
    }
  })
  .catch(() => error.textContent = "Failed to connect to server");

});

</script>

</body>
</html>
