<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mail Sender</title>
<style>
  body { font-family: Arial, sans-serif; padding: 10px; background: #f4f6f9; }
  h2 { text-align:center; color:#333; }
  form {
    background-image: linear-gradient(to right,#ff4d00,#7d20cb);
    padding: 20px; border-radius: 12px; max-width:720px; margin:12px auto;
    display:grid; grid-template-columns: 1fr 1fr; gap:10px 16px;
  }
  label { font-weight:600; color:#faf7f7; display:block; margin-bottom:4px; }
  input, select, button { padding:8px; border-radius:8px; font-size:13px; border:2px solid #ccc; width:100%;}
  input:focus, select:focus { outline:none; border-color:#007bff; box-shadow:0 0 5px rgba(0,123,255,0.25); }
  #accountDetails { grid-column:span 2; display:none; background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; }
  .error { color:#ffdddd; background:#a94442; padding:8px; border-radius:6px; grid-column:span 2; display:none; }
  button { background:#007bff; color:#fff; border:none; cursor:pointer; grid-column:span 2; font-weight:700; }
  button[disabled] { opacity:0.6; cursor:default; }
  .small { font-size:12px; color:#222; }
</style>
</head>
<body>
<h2>Branch Mail Sender</h2>

<form id="mailForm" enctype="multipart/form-data">
  <div>
    <label for="mailType">Mail Type*</label>
    <select id="mailType" required>
      <option value="">Select Mail Type</option>
      <option>Packet Hold From The Auction</option>
      <option>Packet Availability Confirmation</option>
      <option>Customer Query For Auction Surplus</option>
      <option>Customer Query for Auction Details</option>
      <option>Handover the DD To The Customer</option>
      <option>Transfer of Surplus Amount To Customer</option>
    </select>
  </div>

  <div>
    <label for="glId">GL ID*</label>
    <input id="glId" pattern="\d+" required placeholder="numbers only">
  </div>

  <div>
    <label for="customerName">Customer Name*</label>
    <input id="customerName" pattern="[A-Za-z\s]+" required placeholder="Customer name">
  </div>

  <div>
    <label for="customerNumber">Customer Number*</label>
    <input id="customerNumber" pattern="\d+" required placeholder="Customer phone/number">
  </div>

  <div>
    <label for="branchNameInput">Branch Name*</label>
    <input list="branchList" id="branchNameInput" required placeholder="Select or type branch">
    <datalist id="branchList">
      <option value="Test">
      <option value="Fed - Pune / Pimple Saudagar">
    </datalist>
  </div>

  <div>
    <label for="mappedEmail">Mapped Email*</label>
    <input id="mappedEmail" type="email" readonly required placeholder="Branch mapped email">
  </div>

  <div>
    <label for="regards">Regards*</label>
    <select id="regards" required>
      <option value="">Select</option>
      <!-- direct-send (password) group -->
      <option>Vijay</option>
      <option>Manasa</option>
      <option>Yatish</option>
      <option>Arif</option>
      <option>Kartik</option>
      <option>Rajendra</option>
      <option>Prashanth</option>
      <option>Vidyadhar</option>

      <!-- approval groups -->
      <option>Asha</option>
      <option>Eram</option>
      <option>Archana</option>

      <option>Nageena</option>
      <option>Sana</option>

      <option>Azmath</option>
      <option>Fouziya</option>
      <option>Krishnaveni</option>
      <option>Margaret</option>
    </select>
  </div>

  <div id="passwordDiv">
    <label for="password">Password*</label>
    <input id="password" type="password" placeholder="Enter password (if required)">
  </div>

  <div id="accountDetails">
    <label for="bankAccount">Bank A/C Number*</label>
    <input id="bankAccount" type="text" placeholder="Account number">

    <label for="bankName">Bank Name*</label>
    <input id="bankName" type="text" placeholder="Bank name">

    <label for="ifsc">IFSC Code*</label>
    <input id="ifsc" type="text" placeholder="IFSC code">

    <label for="passbook">Passbook / Cheque Leaf*</label>
    <input id="passbook" type="file" accept=".pdf,image/*">

    <label for="aadhar">Aadhar (optional)</label>
    <input id="aadhar" type="file" accept=".pdf,image/*">

    <label for="pan">PAN (optional)</label>
    <input id="pan" type="file" accept=".pdf,image/*">
  </div>

  <div class="error" id="errorMsg"></div>

  <button id="sendMailBtn" type="submit">Send Mail</button>
  <div class="small" style="grid-column:span 2; text-align:center; margin-top:6px;">
    After sending, approved mails are auto-forwarded to the mapped email.
  </div>
</form>

<script>
/* ======= CONFIG: replace with your Apps Script web app URL ======= */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxYxY44eWjQERFi8Yos2doxqfQWH_6alN4laCcVkaheVd3exS2pXuVKscj0NVoAaN5X/exec";
/* ================================================================ */

const branchEmails = {
  "Test":"vidyadhar.patil@rupeek.com",
  "Fed - Pune / Pimple Saudagar":"pnei@federalbank.co.in"
};

const directSendWithPassword = ["Vijay","Manasa","Yatish","Arif","Kartik","Rajendra","Prashanth","Vidyadhar"];
const regardsPasswords = {
  "Vijay":"F6gQ3","Manasa":"t9Bv4","Yatish":"m3Pq2","Arif":"Z5yL0","Kartik":"A7d9X",
  "Rajendra":"R2hK8","Prashanth":"c7Nw1","Vidyadhar":"3834"
};

const approvalEmails = {
  "Asha":"arif.pasha@rupeek.com",
  "Eram":"arif.pasha@rupeek.com",
  "Archana":"arif.pasha@rupeek.com",
  "Nageena":"yatish.r@rupeek.com",
  "Sana":"yatish.r@rupeek.com",
  "Azmath":"m.manasa@rupeek.com",
  "Manasa":"m.manasa@rupeek.com",      // note: Manasa is also in direct-send group (password) — password takes precedence
  "Fouziya":"vijay.r01@rupeek.com",
  "Krishnaveni":"vijay.r01@rupeek.com",
  "Margaret":"vijay.r01@rupeek.com"
};

const mailTypeEl = document.getElementById('mailType');
const branchNameInput = document.getElementById('branchNameInput');
const mappedEmailEl = document.getElementById('mappedEmail');
const regardsEl = document.getElementById('regards');
const passwordEl = document.getElementById('password');
const passwordDiv = document.getElementById('passwordDiv');
const accountDetails = document.getElementById('accountDetails');
const form = document.getElementById('mailForm');
const errorMsg = document.getElementById('errorMsg');
const sendBtn = document.getElementById('sendMailBtn');
const customerNameInput = document.getElementById('customerName');

branchNameInput.addEventListener('input', () => {
  mappedEmailEl.value = branchEmails[branchNameInput.value] || '';
});

customerNameInput.addEventListener('input', () => {
  const words = customerNameInput.value.split(' ').filter(Boolean).map(w => w[0]?.toUpperCase() + w.slice(1).toLowerCase());
  customerNameInput.value = words.join(' ');
});

regardsEl.addEventListener('change', () => {
  const r = regardsEl.value;
  // show password for direct-send group
  if (directSendWithPassword.includes(r)) {
    passwordDiv.style.display = 'block';
  } else {
    passwordDiv.style.display = 'none';
    passwordEl.value = '';
  }

  // show bank/account section only for Transfer of Surplus AND when direct send (we require bank details only when direct send)
  if (mailTypeEl.value === "Transfer of Surplus Amount To Customer" && directSendWithPassword.includes(r)) {
    accountDetails.style.display = 'grid';
  } else {
    accountDetails.style.display = 'none';
  }
});

mailTypeEl.addEventListener('change', () => {
  // re-evaluate accountDetails visibility when mail type changes
  const r = regardsEl.value;
  if (mailTypeEl.value === "Transfer of Surplus Amount To Customer" && directSendWithPassword.includes(r)) {
    accountDetails.style.display = 'grid';
  } else {
    accountDetails.style.display = 'none';
  }
});

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function getEmailContent(data){
  let subject='', body=`Dear Branch Staff,<br><br>`;
  switch(data.mailType){
    case "Packet Hold From The Auction":
      subject=`Hold The Packet From The Auction ${data.glId}-${data.customerName}`;
      body+=`Kindly hold the packet from the auction, as the customer is willing to do the payment<br><br>`;
      break;
    case "Packet Availability Confirmation":
      subject=`Packet Availability Confirmation ${data.glId}-${data.customerName}`;
      body+=`Kindly confirm the packet availability status for below mentioned customer, and the customer is willing to do the payment<br><br>`;
      break;
    case "Customer Query for Auction Details":
      subject=`Customer Query for Auction Details ${data.glId}-${data.customerName}`;
      body+=`Customer has reached out to us requesting the gold auction details. You are requested to kindly furnish the auction details for the information of customer <br>Please find the customer details below.<br><br>`;
      break;
    case "Customer Query For Auction Surplus":
      subject=`Customer Query For Auction Surplus ${data.glId}-${data.customerName}`;
      body+=`Customer ${data.customerName} has requested details of the auction surplus (if any). You are kindly requested to furnish the surplus details for the customer’s information.<br>Please find the customer details below.<br><br>`;
      break;
    case "Transfer of Surplus Amount To Customer":
      subject=`Transfer of Surplus Amount To Customer ${data.glId}-${data.customerName}`;
      body+=`Customer has reached out to us requesting the transfer of the surplus amount. You are requested to confirm the same at the earliest.<br>Please find the customer details below.<br><br>`;
      break;
    case "Handover the DD To The Customer":
      subject=`Handover the DD To The Customer ${data.glId}-${data.customerName}`;
      body+=` Customer has reached out to us requesting for the available DD, Kindly Handover to the customer. <br>Details are provided below.<br><br>`;
      break;
  }

  body += `
<table style="width:100%; max-width:600px; border-collapse:collapse; font-family:Arial, sans-serif; font-size:14px; color:#333;">
  <tr>
    <td style="background:#f4f6f9; font-weight:bold; padding:8px; border:1px solid #ddd; width:35%;">GL ID</td>
    <td style="padding:8px; border:1px solid #ddd;">${data.glId}</td>
  </tr>
  <tr>
    <td style="background:#f4f6f9; font-weight:bold; padding:8px; border:1px solid #ddd;">Customer Name</td>
    <td style="padding:8px; border:1px solid #ddd;">${data.customerName}</td>
  </tr>
  <tr>
    <td style="background:#f4f6f9; font-weight:bold; padding:8px; border:1px solid #ddd;">Customer Number</td>
    <td style="padding:8px; border:1px solid #ddd;">${data.customerNumber}</td>
  </tr>
  <tr>
    <td style="background:#f4f6f9; font-weight:bold; padding:8px; border:1px solid #ddd;">Branch Name</td>
    <td style="padding:8px; border:1px solid #ddd;">${data.branchName}</td>
  </tr>
</table>
`;

  if(data.mailType==="Transfer of Surplus Amount To Customer" && data.bankAccount){
    body += `
<br>
<b style="font-family:Arial, sans-serif; font-size:15px; color:#222;">Bank Details:</b><br><br>
<table style="width:100%; max-width:600px; border-collapse:collapse; font-family:Arial, sans-serif; font-size:14px; color:#333;">
  <tr>
    <td style="background:#f4f6f9; font-weight:bold; padding:8px; border:1px solid #ddd; width:35%;">Bank A/C Number</td>
    <td style="padding:8px; border:1px solid #ddd;">${data.bankAccount}</td>
  </tr>
  <tr>
    <td style="background:#f4f6f9; font-weight:bold; padding:8px; border:1px solid #ddd;">Bank Name</td>
    <td style="padding:8px; border:1px solid #ddd;">${data.bankName}</td>
  </tr>
  <tr>
    <td style="background:#f4f6f9; font-weight:bold; padding:8px; border:1px solid #ddd;">IFSC Code</td>
    <td style="padding:8px; border:1px solid #ddd;">${data.ifsc}</td>
  </tr>
</table>
<br>
<i style="font-family:Arial, sans-serif; font-size:13px; color:#555;">Supporting documents attached.</i><br>
`;
  }

  body+=`<br><br>Regards,<br>${data.regards}`;
  return {subject, body};
}

/* === submit handler === */
form.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  errorMsg.style.display = 'none';
  errorMsg.textContent = '';

  // minimal required client-side validation
  const requiredFields = ['mailType','glId','customerName','customerNumber','branchNameInput','mappedEmail','regards'];
  for (const id of requiredFields) {
    const el = document.getElementById(id === 'branchNameInput' ? 'branchNameInput' : id);
    if (!el || !el.value || String(el.value).trim()==='') {
      errorMsg.style.display = 'block';
      errorMsg.textContent = `${id} is required`;
      return;
    }
  }

  const regardsVal = regardsEl.value;

  // password check client-side (for direct send group)
  if (directSendWithPassword.includes(regardsVal)) {
    if (!passwordEl.value || passwordEl.value !== regardsPasswords[regardsVal]) {
      errorMsg.style.display = 'block';
      errorMsg.textContent = "Password required or incorrect for selected Regards";
      return;
    }
  }

  // build payload
  const data = {
    mailType: mailTypeEl.value,
    glId: document.getElementById('glId').value,
    customerName: customerNameInput.value,
    customerNumber: document.getElementById('customerNumber').value,
    branchName: branchNameInput.value,
    mappedEmail: mappedEmailEl.value,
    regards: regardsVal,
    password: passwordEl.value || ''
  };

  // decide toEmail: direct send => mappedEmail, otherwise approval email
  const needsApproval = !directSendWithPassword.includes(regardsVal);
  data.toEmail = needsApproval ? (approvalEmails[regardsVal] || "") : data.mappedEmail;

  // attach bank details & files (only required & sent when Transfer of Surplus AND direct send)
  if (mailTypeEl.value === "Transfer of Surplus Amount To Customer" && !needsApproval) {
    data.bankAccount = document.getElementById('bankAccount').value;
    data.bankName = document.getElementById('bankName').value;
    data.ifsc = document.getElementById('ifsc').value;

    const passbookFile = document.getElementById('passbook').files[0];
    if (passbookFile) {
      data.passbook = await fileToBase64(passbookFile);
      data.passbookType = passbookFile.type || 'application/pdf';
    }
    const aadharFile = document.getElementById('aadhar').files[0];
    if (aadharFile) {
      data.aadhar = await fileToBase64(aadharFile);
      data.aadharType = aadharFile.type || 'application/pdf';
    }
    const panFile = document.getElementById('pan').files[0];
    if (panFile) {
      data.pan = await fileToBase64(panFile);
      data.panType = panFile.type || 'application/pdf';
    }
  }

  // produce subject & body for clarity (optional — Apps Script can also compute)
  const emailContent = getEmailContent(data);
  data.subject = emailContent.subject;
  data.body = emailContent.body;

  // POST to Apps Script
  sendBtn.disabled = true;
  sendBtn.textContent = 'Sending...';

  try {
    const resp = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const json = await resp.json();
    if (json.status === 'success') {
      // If it was approval workflow, server will auto-forward after approval (server behavior)
      alert('Mail processed successfully.');
      form.reset();
      mappedEmailEl.value = '';
      accountDetails.style.display = 'none';
      passwordDiv.style.display = 'block';
    } else {
      errorMsg.style.display = 'block';
      errorMsg.textContent = json.message || 'Server error';
    }
  } catch (err) {
    errorMsg.style.display = 'block';
    errorMsg.textContent = 'Failed to fetch / server error: ' + (err.message || err);
  } finally {
    sendBtn.disabled = false;
    sendBtn.textContent = 'Send Mail';
  }
});
</script>
</body>
</html>
