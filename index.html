<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Auction Mail System</title>
<style>
body { font-family: Arial; padding: 20px; }
.hidden { display: none; }
label { font-weight: bold; }
input, select { width: 100%; padding: 8px; margin-bottom: 10px; }
.error { color: red; font-weight: bold; }
</style>
</head>

<body>

<h2>Auction Mail Sender</h2>
<p class="error" id="errorMsg"></p>

<form id="mailForm">

<label>Mail Type</label>
<select id="mailType" required>
  <option value="">Select</option>
  <option>Packet Hold From The Auction</option>
  <option>Packet Availability Confirmation</option>
  <option>Customer Query for Auction Details</option>
  <option>Customer Query For Auction Surplus</option>
  <option>Transfer of Surplus Amount To Customer</option>
  <option>Handover the DD To The Customer</option>
</select>

<label>GL ID</label>
<input id="glId" required>

<label>Customer Name</label>
<input id="customerName" required>

<label>Customer Number</label>
<input id="customerNumber" required>

<label>Branch Name</label>
<input id="branchName" required>

<label>Mapped Email</label>
<input id="mappedEmail" required>

<label>Regards</label>
<select id="regards" required>
  <option value="">Select</option>

  <!-- DIRECT SEND WITH PASSWORD -->
  <option>Vijay</option>
  <option>Manasa</option>
  <option>Yatish</option>
  <option>Arif</option>
  <option>Kartik</option>
  <option>Rajendra</option>
  <option>Prashanth</option>
  <option>Vidyadhar</option>

  <!-- APPROVAL GROUPS -->
  <optgroup label="Approval Flow">
    <option>Asha</option>
    <option>Eram</option>
    <option>Archana</option>

    <option>Nageena</option>
    <option>Sana</option>

    <option>Azmath</option>

    <option>Fouziya</option>
    <option>Krishnaveni</option>
    <option>Margaret</option>
  </optgroup>
</select>

<div id="passwordBox" class="hidden">
<label>Password</label>
<input type="password" id="password">
</div>

<div id="accountDetails" class="hidden">

<h3>Account Details (Only for Surplus Transfer)</h3>

<label>Bank Account Number</label>
<input id="bankAccount">

<label>Bank Name</label>
<input id="bankName">

<label>IFSC</label>
<input id="ifsc">

<label>Passbook (image/pdf)</label>
<input type="file" id="passbook" accept="image/*,application/pdf">

<label>Aadhar (optional)</label>
<input type="file" id="aadhar" accept="image/*,application/pdf">

<label>PAN (optional)</label>
<input type="file" id="pan" accept="image/*,application/pdf">

</div>

<button type="submit">Send</button>

</form>

<script>
// ------------ DIRECT SEND PASSWORD USERS ------------
const directUsers = ["Vijay","Manasa","Yatish","Arif","Kartik","Rajendra","Prashanth","Vidyadhar"];

const passwords = {
  "Vijay":"F6gQ3",
  "Manasa":"t9Bv4",
  "Yatish":"m3Pq2",
  "Arif":"Z5yL0",
  "Kartik":"A7d9X",
  "Rajendra":"R2hK8",
  "Prashanth":"c7Nw1",
  "Vidyadhar":"3834"
};

// ------------ APPROVAL GROUPS ------------
const approvalMap = {
  "Asha":"arif.pasha@rupeek.com",
  "Eram":"arif.pasha@rupeek.com",
  "Archana":"arif.pasha@rupeek.com",

  "Nageena":"yatish.r@rupeek.com",
  "Sana":"yatish.r@rupeek.com",

  "Azmath":"m.manasa@rupeek.com",
  "Manasa":"m.manasa@rupeek.com",

  "Fouziya":"vijay.r01@rupeek.com",
  "Krishnaveni":"vijay.r01@rupeek.com",
  "Margaret":"vijay.r01@rupeek.com"
};

// ------------ SHOW / HIDE FIELDS ------------
regards.addEventListener("change", () => {
  passwordBox.classList.toggle("hidden", !directUsers.includes(regards.value));
});

// Surplus account details
mailType.addEventListener("change", () => {
  accountDetails.classList.toggle("hidden", mailType.value !== "Transfer of Surplus Amount To Customer");
});

// ------------ FILE TO BASE64 ------------
function toBase64(file) {
  return new Promise(res => {
    const reader = new FileReader();
    reader.onload = () => res(reader.result.split(",")[1]);
    reader.readAsDataURL(file);
  });
}

// ------------ EMAIL CONTENT BUILDER ------------
function getEmailContent(data) {
  let subject="";
  let body=`Dear Branch Staff,<br><br>`;

  switch(data.mailType){
    case "Packet Hold From The Auction":
      subject=`Hold The Packet From The Auction ${data.glId}-${data.customerName}`;
      body+=`Kindly hold the packet from the auction...<br><br>`;
      break;

    case "Packet Availability Confirmation":
      subject=`Packet Availability Confirmation ${data.glId}-${data.customerName}`;
      body+=`Kindly confirm the packet availability...<br><br>`;
      break;

    case "Customer Query for Auction Details":
      subject=`Customer Query for Auction Details ${data.glId}-${data.customerName}`;
      body+=`Customer has requested auction details...<br><br>`;
      break;

    case "Customer Query For Auction Surplus":
      subject=`Customer Query For Auction Surplus ${data.glId}-${data.customerName}`;
      body+=`Customer requested surplus details...<br><br>`;
      break;

    case "Transfer of Surplus Amount To Customer":
      subject=`Transfer of Surplus Amount To Customer ${data.glId}-${data.customerName}`;
      body+=`Customer requested surplus transfer...<br><br>`;
      break;

    case "Handover the DD To The Customer":
      subject=`Handover the DD To The Customer ${data.glId}-${data.customerName}`;
      body+=`Please hand over DD to customer...<br><br>`;
      break;
  }

  body+=`GL ID: ${data.glId}<br>
         Customer: ${data.customerName}<br>
         Number: ${data.customerNumber}<br>
         Branch: ${data.branchName}<br><br>
         Regards,<br>${data.regards}`;

  return {subject, body};
}

// ------------ FORM SUBMISSION ------------
mailForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  errorMsg.textContent="";

  const data = {
    mailType: mailType.value,
    glId: glId.value,
    customerName: customerName.value,
    customerNumber: customerNumber.value,
    branchName: branchName.value,
    mappedEmail: mappedEmail.value,
    regards: regards.value
  };

  // Password check
  if (directUsers.includes(data.regards)) {
    if (!password.value || passwords[data.regards] !== password.value) {
      errorMsg.textContent="Invalid password";
      return;
    }
    data.password = password.value;
    data.toEmail = mappedEmail.value;   // Direct send
  } else {
    data.approvalEmail = approvalMap[data.regards];
    data.toEmail = data.approvalEmail;  // Approval flow
  }

  // Surplus attachments
  if (mailType.value === "Transfer of Surplus Amount To Customer") {
    data.bankAccount = bankAccount.value;
    data.bankName = bankName.value;
    data.ifsc = ifsc.value;

    if (!passbook.files.length) {
      errorMsg.textContent="Passbook required";
      return;
    }

    data.passbook = await toBase64(passbook.files[0]);
    data.passbookType = passbook.files[0].type;

    if (aadhar.files.length) {
      data.aadhar = await toBase64(aadhar.files[0]);
      data.aadharType = aadhar.files[0].type;
    }

    if (pan.files.length) {
      data.pan = await toBase64(pan.files[0]);
      data.panType = pan.files[0].type;
    }
  }

  // Build email content
  const email = getEmailContent(data);
  data.subject = email.subject;
  data.body = email.body;

  // SEND to script
  const res = await fetch("https://script.google.com/macros/s/AKfycbwr06W4pZNA_3VaQg3VpuTI4Wr3XrFHXUpGjPmEpJHxuSyJF7OqTX6IVZCL9sh_KS-3/exec", {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });

  alert("Mail sent successfully!");
});
</script>

</body>
</html>
