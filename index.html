<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Regards Mail Form (GitHub Frontend)</title>
<style>
  /* Minimal copy of your UI + overlay loader */
  body{font-family:Arial;margin:0;background:#f4f6f9;display:flex;justify-content:center;padding:18px}
  form{background:#fff;padding:22px;width:760px;border-radius:12px;box-shadow:0 6px 30px rgba(0,0,0,0.08)}
  h2{font-size:20px;margin:0 0 12px;background:linear-gradient(90deg,#7d20cb,#ff4d00);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px 16px}
  .full{grid-column:span 2}
  label{display:block;font-weight:600;margin-bottom:6px;color:#222}
  input,select,textarea{width:100%;padding:8px 10px;border-radius:8px;border:1px solid #d6dbe2;font-size:14px}
  .drop-zone{border:2px dashed #7d20cb;border-radius:10px;padding:12px;text-align:center;cursor:pointer;background:#fbf7ff}
  .preview-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
  .preview-box{border:1px solid #e6eaef;padding:8px;border-radius:8px;position:relative;background:#fff;text-align:center}
  .delete-btn{position:absolute;top:6px;right:6px;background:#e74c3c;color:#fff;border:none;border-radius:4px;padding:4px 6px;cursor:pointer}
  button{width:100%;padding:10px;border-radius:10px;border:none;background:linear-gradient(90deg,#ff4d00,#7d20cb);color:#fff;font-weight:700;cursor:pointer}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:9999}
  .loader-card{background:rgba(255,255,255,0.98);padding:18px 24px;border-radius:12px;display:flex;gap:12px;align-items:center}
  .spinner{width:36px;height:36px;border-radius:50%;border:4px solid rgba(125,32,203,0.2);border-top-color:#7d20cb;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .small{font-size:13px;color:#666;margin-top:8px}
  @media (max-width:760px){form{width:100%}.preview-grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<form id="mailForm">
  <h2>Regards Mail Form</h2>

  <div class="grid">
    <div>
      <label>Mail Type*</label>
      <select id="mailType" required>
        <option value="">Select Mail Type</option>
        <option>Packet Hold From The Auction</option>
        <option>Packet Availability Confirmation</option>
        <option>Customer Query For Auction Surplus</option>
        <option>Customer Query for Auction Details</option>
        <option>Handover the DD To The Customer</option>
        <option>Transfer of Surplus Amount To Customer</option>
      </select>
    </div>

    <div>
      <label>GL ID*</label>
      <input id="glId" required />
    </div>

    <div>
      <label>Customer Name*</label>
      <input id="customerName" required />
    </div>

    <div>
      <label>Customer Number*</label>
      <input id="customerNumber" required />
    </div>

    <div>
      <label>Branch Name*</label>
      <select id="branchName" required>
        <option value="">Select Branch</option>
        <option>Test</option>
        <option>Fed - BANGALORE / ST. MARKS ROAD</option>
        <option>Fed - BANGALORE / GANDHI NAGAR</option>
        <option>Fed - BANGALORE / RAJAJI NAGAR</option>
      </select>
    </div>

    <div>
      <label>Branch Email</label>
      <input id="branchEmail" readonly />
    </div>

    <div>
      <label>Regards*</label>
      <select id="regards" required>
        <option value="">--Select Name--</option>
        <option>Vijay</option><option>Manasa</option><option>Yatish</option>
        <option>Arif</option><option>Kartik</option><option>Rajendra</option>
        <option>Prashanth</option><option>Vidyadhar</option>
        <option>Fouziya</option><option>Krishnaveni</option><option>Margaret</option>
        <option>Azmath</option><option>Nageena</option><option>Sana</option>
        <option>Asha</option><option>Eram</option><option>Archana</option>
      </select>
    </div>

    <div id="inputContainer" class="full"></div>

    <!-- Bank details shown only for Transfer -->
    <div id="accountDetails" class="full" style="display:none">
      <div style="font-weight:700;margin-bottom:8px">Bank Details (required for Transfer)</div>
      <div class="grid">
        <div>
          <label>Account Holder Name*</label>
          <input id="accountHolder" />
        </div>
        <div>
          <label>Bank Name*</label>
          <input id="bankName" />
        </div>
        <div>
          <label>Branch Name*</label>
          <input id="branchBankName" />
        </div>
        <div>
          <label>Account Number*</label>
          <input id="accountNumber" />
        </div>
        <div>
          <label>Confirm Account Number*</label>
          <input id="confirmAccountNumber" />
        </div>
        <div>
          <label>IFSC Code*</label>
          <input id="ifsc" />
        </div>

        <div class="full">
          <label>Bank Address (optional)</label>
          <input id="bankAddress" />
        </div>
        <div class="full">
          <label>Customer ID / CIF (optional)</label>
          <input id="customerId" />
        </div>
      </div>

      <div style="margin-top:12px;">
        <label class="small">Attachments (required for Transfer) — Max 4</label>
        <div class="drop-zone" id="dropZone">Click or drag files here</div>
        <input id="fileInput" type="file" multiple style="display:none" />
        <div id="previewContainer" class="preview-grid"></div>
      </div>
    </div>
  </div>

  <div style="margin-top:14px">
    <button id="submitBtn" type="submit">Submit</button>
  </div>

  <div id="message" class="small"></div>
</form>

<!-- Overlay loader -->
<div id="overlay" class="overlay">
  <div class="loader-card">
    <div class="spinner" aria-hidden="true"></div>
    <div>
      <div style="font-weight:700">Processing…</div>
      <div style="font-size:13px;color:#555;margin-top:4px">Please do not close this window.</div>
    </div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
// replace with your Apps Script web app URL (deployed)
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbylMMuRNzU9u9Aza7qv8EsIPsM0aGfsQNN3D8OOLA_USW_YSylI1EugALiuim2lRBRZ/exec";

/* ====== UI & logic (same as before) ====== */
const group1 = ["Vijay","Manasa","Yatish","Arif","Kartik","Rajendra","Prashanth","Vidyadhar"];
const group2 = ["Fouziya","Krishnaveni","Margaret","Azmath","Nageena","Sana","Asha","Eram","Archana"];
const group2Emails = ["vidyadhar.patil@rupeek.com","yatish.r@rupeek.com","m.manasa@rupeek.com","vijay.r01@rupeek.com"];
const branchEmailMap = {
  "Test":"vidyadhar.patil@rupeek.com",
  "Fed - BANGALORE / ST. MARKS ROAD":"bgra@federalbank.co.in",
  "Fed - BANGALORE / GANDHI NAGAR":"bgrb@federalbank.co.in",
  "Fed - BANGALORE / RAJAJI NAGAR":"bgrd@federalbank.co.in"
};

let currentGroup = null;
let selectedFiles = [];

const regardsSelect = document.getElementById('regards');
const inputContainer = document.getElementById('inputContainer');
const branchSelect = document.getElementById('branchName');
const branchEmailInput = document.getElementById('branchEmail');
const mailTypeSelect = document.getElementById('mailType');
const accountDetailsDiv = document.getElementById('accountDetails');
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const previewContainer = document.getElementById('previewContainer');
const submitBtn = document.getElementById('submitBtn');
const overlay = document.getElementById('overlay');
const messageDiv = document.getElementById('message');

regardsSelect.addEventListener('change', () => {
  inputContainer.innerHTML = '';
  const s = regardsSelect.value;
  if (group1.includes(s)) {
    currentGroup = 'group1';
    inputContainer.innerHTML = `<label>Password</label><input id="password" type="password" />`;
  } else if (group2.includes(s)) {
    currentGroup = 'group2';
    let html = `<label>Select Approver Email</label><select id="group2Email"><option value="">--Select--</option>`;
    group2Emails.forEach(e => html += `<option value="${e}">${e}</option>`);
    html += `</select>`;
    inputContainer.innerHTML = html;
  } else {
    currentGroup = null;
  }
});

branchSelect.addEventListener('change', () => {
  branchEmailInput.value = branchEmailMap[branchSelect.value] || '';
});

mailTypeSelect.addEventListener('change', () => {
  if (mailTypeSelect.value === "Transfer of Surplus Amount To Customer") accountDetailsDiv.style.display = 'block';
  else accountDetailsDiv.style.display = 'none';
});

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.background = '#f1e6ff'; });
dropZone.addEventListener('dragleave', () => { dropZone.style.background = '#fbf7ff'; });
dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.style.background = '#fbf7ff'; handleFiles(e.dataTransfer.files); });
fileInput.addEventListener('change', () => handleFiles(fileInput.files));

function handleFiles(files) {
  if (!files) return;
  if (selectedFiles.length + files.length > 4) { alert('Maximum 4 files allowed'); return; }
  for (let f of files) selectedFiles.push(f);
  renderPreviews();
}
function deleteFile(i) { selectedFiles.splice(i,1); renderPreviews(); }
function renderPreviews(){
  previewContainer.innerHTML = '';
  selectedFiles.forEach((file,idx) => {
    const box = document.createElement('div'); box.className='preview-box';
    const del = document.createElement('button'); del.className='delete-btn'; del.innerText='X'; del.onclick=()=>deleteFile(idx);
    box.appendChild(del);
    if (file.type && file.type.indexOf('image')!==-1) { const img=document.createElement('img'); img.src=URL.createObjectURL(file); box.appendChild(img); }
    const nm = document.createElement('div'); nm.innerText = file.name; box.appendChild(nm);
    previewContainer.appendChild(box);
  });
}

// helper overlay
function startLoading(){ submitBtn.disabled=true; overlay.style.display='flex'; }
function stopLoading(){ submitBtn.disabled=false; overlay.style.display='none'; }

// submit
document.getElementById('mailForm').addEventListener('submit', function(ev){
  ev.preventDefault();
  messageDiv.style.color = '#c0392b';
  messageDiv.innerText = '';

  // collect fields
  const data = {
    mailType: document.getElementById('mailType').value,
    regards: document.getElementById('regards').value,
    branchEmail: document.getElementById('branchEmail').value,
    glId: document.getElementById('glId').value.trim(),
    customerName: document.getElementById('customerName').value.trim(),
    customerNumber: document.getElementById('customerNumber').value.trim(),
    branchName: document.getElementById('branchName').value
  };

  // bank details
  data.accountHolder = document.getElementById('accountHolder').value.trim();
  data.bankName = document.getElementById('bankName').value.trim();
  data.branchBankName = document.getElementById('branchBankName').value.trim();
  data.accountNumber = document.getElementById('accountNumber').value.trim();
  data.confirmAccountNumber = document.getElementById('confirmAccountNumber').value.trim();
  data.ifsc = document.getElementById('ifsc').value.trim();
  data.bankAddress = document.getElementById('bankAddress').value.trim();
  data.customerId = document.getElementById('customerId').value.trim();

  // group fields
  if (currentGroup === 'group1') data.password = document.getElementById('password')?.value || '';
  if (currentGroup === 'group2') data.group2Email = document.getElementById('group2Email')?.value || '';

  // basic validation
  if (!data.mailType || !data.regards || !data.glId || !data.customerName || !data.customerNumber || !data.branchName) {
    messageDiv.innerText = 'Please fill required fields.';
    return;
  }

  if (data.mailType === "Transfer of Surplus Amount To Customer") {
    if (!data.accountHolder || !data.bankName || !data.branchBankName || !data.accountNumber || !data.confirmAccountNumber || !data.ifsc) {
      messageDiv.innerText = 'Please fill mandatory bank details.';
      return;
    }
    if (data.accountNumber !== data.confirmAccountNumber) {
      messageDiv.innerText = 'Account number mismatch.';
      return;
    }
    if (selectedFiles.length === 0) { messageDiv.innerText = 'Please attach at least one file.'; return; }
  }

  // prepare attachments as base64 array
  const promises = selectedFiles.map(f => new Promise((res,rej) => {
    const reader = new FileReader();
    reader.onload = () => res({ name: f.name, content: reader.result.split(',')[1], mime: f.type || 'application/octet-stream' });
    reader.onerror = rej;
    reader.readAsDataURL(f);
  }));

  startLoading();
  Promise.all(promises).then(attachments => {
    data.attachments = attachments;
    // send to Apps Script (doPost)
    fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
      credentials: 'omit'
    }).then(r => r.json()).then(resp => {
      stopLoading();
      if (resp && resp.success) {
        messageDiv.style.color = '#0a7a11';
        messageDiv.innerText = resp.message || 'Success';
        setTimeout(()=>location.reload(),900);
      } else {
        messageDiv.style.color = '#c0392b';
        messageDiv.innerText = resp && resp.message ? resp.message : 'Error sending';
      }
    }).catch(err => {
      stopLoading();
      messageDiv.style.color = '#c0392b';
      messageDiv.innerText = 'Network/Server error: ' + err.message;
    });
  }).catch(err => {
    stopLoading();
    messageDiv.style.color = '#c0392b';
    messageDiv.innerText = 'File read error: ' + err.message;
  });
});
</script>
</body>
</html>
